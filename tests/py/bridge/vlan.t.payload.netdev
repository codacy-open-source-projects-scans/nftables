# vlan id 4094
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]

# vlan id 0
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0000 ]

# vlan id 4094 vlan dei 0
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x00 ]

# vlan id 4094 vlan dei != 1
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp neq reg 1 0x10 ]

# vlan id 4094 vlan cfi 1
netdev
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x10 ]

# vlan id 4094 vlan dei 1
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x10 ]

# ether type vlan vlan id 4094
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]

# ether type vlan vlan id 0
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0000 ]

# ether type vlan vlan id 4094 vlan dei 0
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x00 ]

# ether type vlan vlan id 4094 vlan dei 1
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x10 ]

# vlan id 4094 tcp dport 22
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ meta load l4proto => reg 1 ]
  [ cmp eq reg 1 0x06 ]
  [ payload load 2b @ transport header + 2 => reg 1 ]
  [ cmp eq reg 1 0x0016 ]

# vlan id 1 ip saddr 10.0.0.1
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 4b @ network header + 12 => reg 1 ]
  [ cmp eq reg 1 0x0a000001 ]

# vlan id 1 ip saddr 10.0.0.0/23
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 4b @ network header + 12 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xfffffe00 ) ^ 0x00000000 ]
  [ cmp eq reg 1 0x0a000000 ]

# vlan id 1 ip saddr 10.0.0.0/23 udp dport 53
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 4b @ network header + 12 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xfffffe00 ) ^ 0x00000000 ]
  [ cmp eq reg 1 0x0a000000 ]
  [ meta load l4proto => reg 1 ]
  [ cmp eq reg 1 0x11 ]
  [ payload load 2b @ transport header + 2 => reg 1 ]
  [ cmp eq reg 1 0x0035 ]

# ether type vlan vlan id 1 ip saddr 10.0.0.0/23 udp dport 53
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 4b @ network header + 12 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xfffffe00 ) ^ 0x00000000 ]
  [ cmp eq reg 1 0x0a000000 ]
  [ meta load l4proto => reg 1 ]
  [ cmp eq reg 1 0x11 ]
  [ payload load 2b @ transport header + 2 => reg 1 ]
  [ cmp eq reg 1 0x0035 ]

# vlan id 4094 vlan dei 1 vlan pcp 7
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x10 ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xe0 ) ^ 0x00 ]
  [ cmp eq reg 1 0xe0 ]

# vlan id 4094 vlan dei 1 vlan pcp 3
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0ffe ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x10 ) ^ 0x00 ]
  [ cmp eq reg 1 0x10 ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xe0 ) ^ 0x00 ]
  [ cmp eq reg 1 0x60 ]

# vlan id { 1, 2, 4, 100, 4095 } vlan pcp 1-3
__set%d test-netdev 3
__set%d test-netdev 0
	element 0001	element 0002	element 0004	element 0064	element 0fff
netdev test-netdev ingress 
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ lookup reg 1 set __set%d ]
  [ payload load 1b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xe0 ) ^ 0x00 ]
  [ range eq reg 1 0x20 0x60 ]

# ether type vlan ip protocol 1 accept
netdev test-netdev ingress
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 1b @ network header + 9 => reg 1 ]
  [ cmp eq reg 1 0x01 ]
  [ immediate reg 0 accept ]

# ether type 8021ad vlan id 1 ip protocol 6 accept
netdev
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x88a8 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 1b @ network header + 9 => reg 1 ]
  [ cmp eq reg 1 0x06 ]
  [ immediate reg 0 accept ]

# ether type 8021ad vlan id 1 vlan type 8021q vlan id 2 vlan type ip counter
netdev
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x88a8 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 18 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0002 ]
  [ payload load 2b @ link header + 20 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ counter pkts 0 bytes 0 ]

# ether type 8021ad vlan id 1 vlan type 8021q vlan id 2 vlan type ip ip protocol 6
netdev
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x88a8 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 16 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 18 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0002 ]
  [ payload load 2b @ link header + 20 => reg 1 ]
  [ cmp eq reg 1 0x0800 ]
  [ payload load 1b @ network header + 9 => reg 1 ]
  [ cmp eq reg 1 0x06 ]

# vlan id 1 vlan id set 2
netdev
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0xf000 ) ^ 0x0002 ]
  [ payload write reg 1 => 2b @ link header + 14 csum_type 0 csum_off 0 csum_flags 0x0 ]

# vlan id 2 ether saddr 0:1:2:3:4:6
netdev test-netdev ingress
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 8b @ link header + 6 => reg 1 ]
  [ cmp eq reg 1 0x00010203 0x04068100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0002 ]

# ether saddr 00:01:02:03:04:05 vlan id 1
netdev test-netdev ingress
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 8b @ link header + 6 => reg 1 ]
  [ cmp eq reg 1 0x00010203 0x04058100 ]
  [ payload load 2b @ link header + 14 => reg 1 ]
  [ bitwise reg 1 = ( reg 1 & 0x0fff ) ^ 0x0000 ]
  [ cmp eq reg 1 0x0001 ]

# ether saddr . vlan id { 0a:0b:0c:0d:0e:0f . 42, 0a:0b:0c:0d:0e:0f . 4095 }
__set%d test-netdev 3 size 2
__set%d test-netdev 0
	element 0a0b0c0d 0e0f . 002a	element 0a0b0c0d 0e0f . 0fff
netdev test-netdev ingress
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
  [ payload load 6b @ link header + 6 => reg 1 ]
  [ payload load 2b @ link header + 14 => reg 10 ]
  [ bitwise reg 10 = ( reg 10 & 0x0fff ) ^ 0x0000 ]
  [ lookup reg 1 set __set%d ]

# ether saddr 00:11:22:33:44:55 counter ether type 8021q
bridge test-bridge input
  [ meta load iiftype => reg 1 ]
  [ cmp eq reg 1 0x0001 ]
  [ payload load 6b @ link header + 6 => reg 1 ]
  [ cmp eq reg 1 0x00112233 0x4455 ]
  [ counter pkts 0 bytes 0 ]
  [ payload load 2b @ link header + 12 => reg 1 ]
  [ cmp eq reg 1 0x8100 ]
